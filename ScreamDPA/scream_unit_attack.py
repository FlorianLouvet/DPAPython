from CommonDPA.dpa_unit_attack import *


class ScreamUnitAttack(DPAUnitAttcack):
    SBOX = {0: 32, 1: 141, 2: 178, 3: 218, 4: 51, 5: 53, 6: 166, 7: 255, 8: 122, 9: 82, 10: 106, 11: 198, 12: 164,
            13: 168, 14: 81, 15: 35, 16: 162, 17: 150, 18: 48, 19: 171, 20: 200, 21: 23, 22: 20, 23: 158, 24: 232,
            25: 243, 26: 248, 27: 221, 28: 133, 29: 226, 30: 75, 31: 216, 32: 108, 33: 1, 34: 14, 35: 61, 36: 182,
            37: 57, 38: 74, 39: 131, 40: 111, 41: 170, 42: 134, 43: 110, 44: 104, 45: 64, 46: 152, 47: 95, 48: 55,
            49: 19, 50: 5, 51: 135, 52: 4, 53: 130, 54: 49, 55: 137, 56: 36, 57: 56, 58: 157, 59: 84, 60: 34, 61: 123,
            62: 99, 63: 189, 64: 117, 65: 44, 66: 71, 67: 233, 68: 194, 69: 96, 70: 67, 71: 172, 72: 87, 73: 161,
            74: 31, 75: 39, 76: 231, 77: 173, 78: 92, 79: 210, 80: 15, 81: 119, 82: 253, 83: 8, 84: 121, 85: 58, 86: 73,
            87: 93, 88: 237, 89: 144, 90: 101, 91: 124, 92: 86, 93: 79, 94: 46, 95: 105, 96: 205, 97: 68, 98: 63,
            99: 98, 100: 91, 101: 136, 102: 107, 103: 196, 104: 94, 105: 45, 106: 103, 107: 11, 108: 159, 109: 33,
            110: 41, 111: 42, 112: 214, 113: 126, 114: 116, 115: 224, 116: 65, 117: 115, 118: 80, 119: 118, 120: 85,
            121: 151, 122: 60, 123: 9, 124: 125, 125: 90, 126: 146, 127: 112, 128: 132, 129: 185, 130: 38, 131: 52,
            132: 29, 133: 129, 134: 50, 135: 43, 136: 54, 137: 100, 138: 174, 139: 192, 140: 0, 141: 238, 142: 143,
            143: 167, 144: 190, 145: 88, 146: 220, 147: 127, 148: 236, 149: 155, 150: 120, 151: 16, 152: 204, 153: 47,
            154: 148, 155: 241, 156: 59, 157: 156, 158: 109, 159: 22, 160: 72, 161: 181, 162: 202, 163: 17, 164: 250,
            165: 13, 166: 142, 167: 7, 168: 177, 169: 12, 170: 18, 171: 40, 172: 76, 173: 70, 174: 244, 175: 139,
            176: 169, 177: 207, 178: 187, 179: 3, 180: 160, 181: 252, 182: 239, 183: 37, 184: 128, 185: 246, 186: 179,
            187: 186, 188: 62, 189: 247, 190: 213, 191: 145, 192: 195, 193: 138, 194: 193, 195: 69, 196: 222, 197: 102,
            198: 245, 199: 10, 200: 201, 201: 21, 202: 217, 203: 163, 204: 97, 205: 153, 206: 176, 207: 228, 208: 209,
            209: 251, 210: 211, 211: 78, 212: 191, 213: 212, 214: 215, 215: 113, 216: 203, 217: 30, 218: 219, 219: 2,
            220: 26, 221: 147, 222: 234, 223: 197, 224: 235, 225: 114, 226: 249, 227: 28, 228: 229, 229: 206, 230: 77,
            231: 242, 232: 66, 233: 25, 234: 225, 235: 223, 236: 89, 237: 149, 238: 183, 239: 140, 240: 154, 241: 240,
            242: 24, 243: 230, 244: 199, 245: 175, 246: 188, 247: 184, 248: 227, 249: 27, 250: 208, 251: 165, 252: 83,
            253: 180, 254: 6, 255: 254}

    def __init__(self, traces, values, keys, tweaks):
        super(ScreamUnitAttack, self).__init__(traces, values, keys, tweaks)

    def compute_intermediate_values_matrix(self):
        matrix = np.zeros(
            (np.size(self.values), np.size(self.keys)), dtype=np.int)
        it = np.nditer(matrix, flags=['multi_index'], op_flags=['writeonly'])
        while not it.finished:
            it[0] = ScreamUnitAttack.SBOX[self.values[it.multi_index[0]] ^ self.keys[
                it.multi_index[1]] ^ self.tweaks[it.multi_index[0]]]
            it.iternext()
        self.intermediate_values_matrix = matrix